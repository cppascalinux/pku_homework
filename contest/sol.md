# 题解
首先不难发现，对于序列长度$k$为偶数的情况，我们将所有数排序后放在数轴上，在最优方案中，最外侧的两个间隔会被计算$2$次，向里一层的两个间隔会被计算$4$次，再向里一层的两个间隔会被计算$6$次。。。以此类推，但最中间的一个间隔会被计算$k-1$次  
对于k为奇数的情况同理，不一样的是最中间的两个间隔中，较大的会被计算$k-1$次，较小的会被计算$k-2$次

证明：将每个数视作一个点,要求的就是一条总边权最大的哈密尔顿路径。对于偶数个点的情况，考虑数轴上每个间隔可能被计算的最大次数。显然只有当一条边跨过这个间隔的时候它的贡献才会被计算，而每个点的度数又至多为$2$，所以它被计算的次数$\le2*\min(lsum,rsum)$，其中$lsum,rsum$分别表示这个间隔左右的点的个数。且最中间的间隔无法取到这个上限（否则所有点的度数都必须是$2$，矛盾），也就是至多能取$k-1$次。我们发现可以构造出一条路径取得这个上界：从$\frac k2+1$连向$1$，$1$连向$k$，$k$连向$2$……往后每个点都与尚未连边的距离最远的点连边，就可以取得这个上界  
对于奇数个点的情况类似，中间的两个间隔一定有一个至多只能被取$k-2$次，不妨假设左侧的间隔较大，则从$\lfloor\frac k2\rfloor+1$连向$1$，$1$连向$k$，$k$连向$2$……往后每个点都与尚未连边的距离最远的点连边，也可以取得上界，证毕

因此只需要使用主席树维护值域，每次询问时只需要查询区间中位数，区间和，以及所有比中位数小的数的和即可计算出答案

时间复杂度$O((n+m)\log \max(h_i))$